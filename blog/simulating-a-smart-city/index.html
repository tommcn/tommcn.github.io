<!doctype html><html class=light lang=en><head><meta charset=utf-8><title>Simulating a Smart City using TypeScript</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://tomas.mcnamer.ca/plugins/slick/slick.css as=style onload='this.onload=null,this.rel="stylesheet"' rel=preload><link rel=stylesheet href=https://tomas.mcnamer.ca/plugins/slick/slick-theme.css as=style onload='this.onload=null,this.rel="stylesheet"' rel=preload><link rel=stylesheet href=https://tomas.mcnamer.ca/plugins/font-awesome/css/font-awesome.min.css as=font onload='this.onload=null,this.rel="stylesheet"' rel=preload><link rel=stylesheet href=https://tomas.mcnamer.ca/plugins/magnafic-popup/magnific-popup.css as=style onload='this.onload=null,this.rel="stylesheet"' rel=preload><link href=https://tomas.mcnamer.ca/scss/style.min.css rel=stylesheet as=style onload='this.onload=null,this.rel="stylesheet"' rel=preload><link rel="shortcut icon" href=https://tomas.mcnamer.ca/images/favicon.ico type=image/x-icon><link rel=icon href=https://tomas.mcnamer.ca/images/favicon.png type=image/x-icon><meta name=description content="Tomas McNamer's personal website"></head><body><nav class="navbar navbar-expand-lg fixed-top"><div class=container><a href=https://tomas.mcnamer.ca/ class=navbar-brand><img src=https://tomas.mcnamer.ca/images/site-navigation/logo.webp alt=site-logo></a>
<button type=button class="navbar-toggler collapsed" data-toggle=collapse data-target=#navbarCollapse aria-label="Collapse menu">
<span class=navbar-toggler-icon></span>
<span class=navbar-toggler-icon></span>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-between" id=navbarCollapse><ul class="nav navbar-nav main-navigation my-0 mx-auto"><li class=nav-item><a href=https://tomas.mcnamer.ca/#home class="nav-link text-dark text-sm-center p-2">Home</a></li><li class=nav-item><a href=https://tomas.mcnamer.ca/#about class="nav-link text-dark text-sm-center p-2">About</a></li><li class=nav-item><a href=https://tomas.mcnamer.ca/#portfolio class="nav-link text-dark text-sm-center p-2">Portfolio</a></li><li class=nav-item><a href=https://tomas.mcnamer.ca/#resume class="nav-link text-dark text-sm-center p-2">Resume</a></li><li class=nav-item><a href=https://tomas.mcnamer.ca/#blog class="nav-link text-dark text-sm-center p-2">Blog</a></li><li class=nav-item><a href=https://tomas.mcnamer.ca/#contact class="nav-link text-dark text-sm-center p-2">Contact</a></li><li class=nav-item><button class=toggle-mode aria-label="Toggle dark mode"><i class="fa fa-moon-o"></i></button></li></ul></div></div></nav><div id=content><header class=breadCrumb><div class=container><div class=row><div class="col-lg-10 col-md-12 offset-lg-1 offset-md-0 text-center"><h3 class=breadCrumb__title>Simulating a Smart City using TypeScript</h3><nav aria-label=breadcrumb class="d-flex justify-content-center"><ol class="breadcrumb align-items-center"><li class=breadcrumb-item><a href=https://tomas.mcnamer.ca/>Home</a></li><li class=breadcrumb-item><a href=https://tomas.mcnamer.ca/blog>All Post</a></li><li class="breadcrumb-item active" aria-current=page>Simulating a Smart City using TypeScript</li></ol></nav></div></div><ul class=post-meta><li><i class="fa fa-calendar"></i>
February 12, 2022</li><li><i class="fa fa-clock-o"></i>
9 mins read</li><li><i class="fa fa-folder-open"></i>
<a class=text-capitalize href=https://tomas.mcnamer.ca/categories/blog/>blog</a></li><li><i class="fa fa-globe"></i>
<a class=text-capitalize href=https://tommcn.medium.com/simulating-a-smart-city-using-typescript-2f7b87d53089>Read on Medium</a></li></ul></div></div></div></div></header><section class="section singleBlog"><div class=svg-img><img src=https://tomas.mcnamer.ca/images/hero/figure-svg.svg alt></div><div class=animate-shape><img src=https://tomas.mcnamer.ca/images/skill/skill-background-shape.svg alt><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 600 600"><defs><linearGradient id="d" x1=".929" y1=".111" x2=".263" y2=".935" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="#f1f6f9"/><stop offset="1" stop-color="#f1f6f9" stop-opacity="0"/></linearGradient></defs><g data-name="blob-shape (3)"><path class="blob" fill="url(#d)" d="M455.4 151.1c43.1 36.7 73.4 92.8 60.8 136.3-12.7 43.5-68.1 74.4-111.3 119.4-43.1 45-74 104.1-109.8 109-35.9 5-76.7-44.2-111.8-89.2-35.2-45-64.7-85.8-70.8-132.6-6-46.8 11.6-99.6 46.7-136.3 35.2-36.6 88-57.2 142.4-58.8 54.5-1.7 110.6 15.6 153.8 52.2z"/></g></svg></div><div class=animate-pattern><img src=https://tomas.mcnamer.ca/images/service/background-pattern.svg alt=background-shape></div><div class=container><div class=row><div class=col-lg-12><div class=singleBlog__feature><img src=https://cdn-images-1.medium.com/max/10944/0*yWNrVaZ3J_gUe2u8 alt=feature-image></div></div></div><div class="row mt-5"><div class=col-lg-12><div class=singleBlog__content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#what-did-i-build>What Did I Build?</a><ul><li><a href=#devices>Devices</a></li><li><a href=#servers>Servers</a></li><li><a href=#database>Database</a></li><li><a href=#docker>Docker</a></li><li><a href=#mqtt>MQTT</a></li></ul></li><li><a href=#code>Code</a><ul><li><a href=#typescript>Typescript</a></li><li><a href=#es6-asynchronous-programming>ES6 Asynchronous Programming</a></li><li><a href=#object-oriented-programming>Object Oriented Programming</a></li></ul></li><li><a href=#examples>Examples</a><ul><li><a href=#device-abstract-class>Device Abstract Class</a></li><li><a href=#streetlamp-device>Streetlamp Device</a></li><li><a href=#influxdb-data>InfluxDB data</a></li></ul></li><li><a href=#next-steps>Next Steps</a></li><li><a href=#further-reading>Further Reading</a></li></ul></nav><h1 id=simulating-a-smart-city-using-typescript>Simulating a Smart City using TypeScript</h1><p>Introduction</p><p>As the urban population of the earth continues to grow, the current city model needs to evolve. Climate change has underlined the necessity to rethink the way we interact with our city. From the way we commute to how we use the power grid, there are definitively things we can do to improve our carbon footprint. But the environment isn’t the only problem plaguing our cities. The way we are using our cities is evolving, they need to evolve with us. This is where the concept of smart cities comes into play.</p><p><img src=https://cdn-images-1.medium.com/max/12032/0*Za8jUfreX6UYzu36 alt="Photo by Hugh Han on Unsplash"><em>Photo by <a href="https://unsplash.com/@hughhan?utm_source=medium&utm_medium=referral">Hugh Han</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><p>A smart city is like a smart house, but on a much larger scale. Using sensors and other embedded devices at the scale of a city, we can save cost, increase accessibility and convenience for all citizens. This is like the way that smart homes can decrease energy consumption and assist you in day-to-day activities.</p><h2 id=what-did-i-build>What Did I Build?</h2><p>I have built a series of programs that, when put together, could simulate how an actual smart city could look like. My solution is split up into three main components: devices, servers, and the database.</p><h3 id=devices>Devices</h3><p>In my solution, devices are the collection of sensors (like a temperature sensor) and actors (like a LED or motor), usually on the same physical device (Arduino, Raspberry Pi, ESP8266…) with a connection to the Internet (or some network). The device can make decisions and can control its actors without necessarily needing to “consult” with a central server. An example of a device could be a streetlamp that would turn on if presence is detected. The device would use its presence sensors to detect the presence of individuals and turn on the streetlamp with LED actors. All this processing happens on the device itself to reduce load on the central server.</p><p>Another example of a device would be a weather station that collects information (like temperature, humidity, wind speed, air quality…) and reports it to some server for storage and analysis.</p><p><img src=https://cdn-images-1.medium.com/max/8000/0*FoAOOr0UJPw-T-SL alt="Photo by NOAA on Unsplash"><em>Photo by <a href="https://unsplash.com/@noaa?utm_source=medium&utm_medium=referral">NOAA</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><h3 id=servers>Servers</h3><p>Devices are nice for small self-contained use-cases, but one will obviously want to create more complex systems, not limited to a single device. For example, let’s take a smart parking garage. You would have proximity sensors on top of every parking spot, with a LED to show drivers which spots in the row are free. You might also want to have a display at the entrance that shows the number of open spots for each floor at the entrance. To do this, you would have a server to which all your parking spots devices would connect, the server would then calculate the number of spots available per floor.</p><p><img src=https://cdn-images-1.medium.com/max/12000/0*exxoEYGDCU0Ba1wa alt="Photo by Jordan Harrison on Unsplash"><em>Photo by <a href="https://unsplash.com/@jordanharrison?utm_source=medium&utm_medium=referral">Jordan Harrison</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><p>You can also have many servers that connect to each other. You might want a central server for all your parkings to display on a website. This allows us to have more distribution computing, like edge computing, which reduces load on a single server and helps save bandwidth.</p><h3 id=database>Database</h3><p>Obviously, with all this data you collect, you will need to store it somewhere. You might think that some standard SQL database (SQLite and PostgreSQL often come to mind) will be fine to hold all your data. However, this will not scale well, if you have hundreds or thousands of data points that need to be committed to a database. Relational Database Management Systems (most SQL databases) are optimized to hold relationships between records and to perform complex queries. However, with our data, we only want to store a small amount of data with a timestamp, no fancy relationships needed. This is where time series databases (TSDB) come in. They can manage hundreds of thousands of points at a time with an extra-precise resolution (down to nanoseconds) and most of them will come with built-in tools for data analysis, aggregation, and visualization.</p><p><img src=https://cdn-images-1.medium.com/max/11520/0*3aroV_pxIXzl9cHC alt="Photo by benjamin lehman on Unsplash"><em>Photo by <a href="https://unsplash.com/@benjaminlehman?utm_source=medium&utm_medium=referral">benjamin lehman</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><p>In my project, I have decided to use <a href=https://www.influxdata.com/products/influxdb/>InfluxDB</a>, but the choice of DB is dependent on your use-case and specific requirements. InfluxDB also comes with built-in data visualization tools, alerting and dashboards. One of the things to keep in mind thought is that the open-source version of InfluxDB doesn’t include a straightforward way to shard the database, meaning that the database will need to be on a single device, which could be dangerous in case of an outage. InfluxDB will do its best to not corrupt or lose data in case of an outage, but downtime will still be a problem in case the database goes down.</p><h3 id=docker>Docker</h3><p>I have decided to run all those services on <a href=https://www.docker.com/>Docker</a>, which, simply put, creates light-weight virtual machines for all the services we run (in my context, a service denotes the code that powers a server or a device). Docker allows us to configure our services easily and run multiple services on a single physical device without worrying about a process hogging ressources (CPU, memory, storage, network…) or interacting with processes it shouldn’t be interacting with. Since Docker runs on top of a virtualization software, should your code be compromised, an attacker would not be able to access the machine and sensitive information (obviously, nothing is 100% secure, running an outdated version of Docker or using less secure options will make it possible for an attacker to escape the sandbox).</p><p><img src=https://cdn-images-1.medium.com/max/9976/0*jVV3ehhe8gGoOzLt alt="Photo by Ian Taylor on Unsplash"><em>Photo by <a href="https://unsplash.com/@carrier_lost?utm_source=medium&utm_medium=referral">Ian Taylor</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><h3 id=mqtt>MQTT</h3><p>Finally, communication between devices and servers is important. It is important to have protocols that are both efficient and reliable. I will not go into details about the protocol as I have already gone into detail in a <a href=https://tommcn.medium.com/building-an-mqttv5-server-in-python-from-scratch-99da4de4337c>previous article</a>.</p><h2 id=code>Code</h2><h3 id=typescript>Typescript</h3><p>As the programming language, I decided to use TypeScript (TS). TS is a superset of the JavaScript (JS) language, and both are some of the most used languages in the world. The appeal of TS when compared to JS is that TS is a strongly typed language, meaning that all the variables have specific types and functions denote their return types. This adds some level of certainty that the code will not run into some of the more common programming errors (Attribute Error, Type Error…).</p><h3 id=es6-asynchronous-programming>ES6 Asynchronous Programming</h3><p>ECMAScript 6 (ES6) is the JS standard that ensures interoperability on different devices and browsers. ES6 is the ES update that came out in 2015, it introduced new ways to use asynchronous programming features. Asynchronous programming is the capability to run functions or statements separately from the main thread. This means that you can start the execution of a function and continue with the rest of the code, essentially running multiple pieces of code at the same time, increasing performance without having to deal with threads.</p><p><img src=https://cdn-images-1.medium.com/max/10944/0*yWNrVaZ3J_gUe2u8 alt="Photo by Stephane Gagnon on Unsplash"><em>Photo by <a href="https://unsplash.com/@metriics?utm_source=medium&utm_medium=referral">Stephane Gagnon</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><h3 id=object-oriented-programming>Object Oriented Programming</h3><p>Finally, using classes, I can easily reuse code that would be the same for all devices. For example, the way the data is sent to the server, or the monitoring code will be the same regardless of the device the code is being deployed on.</p><h2 id=examples>Examples</h2><p><em>Note: the following code samples are incomplete and will not compile on their own. For the full code, see my <a href=https://github.com/tommcn/city-simulator>GitHub repo</a>.</em></p><h3 id=device-abstract-class>Device Abstract Class</h3><p><img src=https://cdn-images-1.medium.com/max/2688/1*5JYuhdZ5yjqVfCWg2gsBHA.png alt="The device abstract class"><em>The device abstract class</em></p><p>This class is an abstract class from which all devices are inherited. As stated earlier, it contains all the code shared by devices.</p><p><strong>Send function</strong></p><p>The send function is responsible for sending data over the MQTT client (client). It publishes data to the things/data/:type/:id channel, which makes it easy for the receiving end to filter which type of data it wants to receive (for example subscribing to the topic things/data/streetlamp/+allows the subscriber to only listen to streetlamp data).</p><p>It knows what data to send by calling the getDataToSendmethod, which returns an object with the data to send. It is up to the implementation of the class to implement this method as the data is specific to the device.</p><p><strong>Tick function</strong></p><p>The tick function is where the code will a function that should be run at a regular interval (like 5 seconds). This piece of code should be responsible for collecting data, sending it to the server and making sure no errors have been thrown.</p><p><strong>Logic function</strong></p><p>This is where the main logic for the device will lie. With our streetlamp example, it’s there that you would check if presence was detected and in there that you would turn the lights on.</p><h3 id=streetlamp-device>Streetlamp Device</h3><p><img src=https://cdn-images-1.medium.com/max/3260/1*NSuw83neGRIT_gP5AdmkDg.png alt="Some of the code for the streetlamp device"><em>Some of the code for the streetlamp device</em></p><p>This is what an example device would look like. Notice the implementation of the logic function. The heavy use of Promise.all(&mldr;) allows me to scale the number of lights without heavily degrading performance.</p><h3 id=influxdb-data>InfluxDB data</h3><p><img src=https://cdn-images-1.medium.com/max/3830/1*OPzaXFGbsw0d6cUhOKwd8A.png alt="InfluxDB visualisation"><em>InfluxDB visualisation</em></p><p>As mentioned above, InfluxDB comes with a nice-looking interface for data visualization and analysis. It contains many useful features, most notably the ability to aggregate data using many distinct functions and see multiple lines on a single chart while allowing us to filter data easily. The InfluxData team also creates their own query language called <em>Flux</em>, which is incredibly powerful when working with lots of data.</p><h2 id=next-steps>Next Steps</h2><p>While I’m happy about what I built there are a lot of features I could add to the project. Firstly, I could add more devices and functionality to my program to create a more realistic simulation. This should be easy because of the way I built the device classes. It would also be cool to test it in the real world with a GPIO library. Another important part of production deployment is monitoring the physical devices the code is deployed on. To monitor the devices and docker container, I could use the <a href=https://www.influxdata.com/time-series-platform/telegraf/>Telegraf</a> agent (built by the same team from InfluxDB) which collects lots of data including number of processes running, disk I/O, RAM, CPU and battery usage, CPU temperature… All of this is important data to ensure that downtime is minimal and perform predictive maintenance.</p><h2 id=further-reading>Further Reading</h2><p>If this was interesting to you, here are some extra ressources:</p><ul><li><p><a href=https://github.com/tommcn/city-simulator>My code on GitHub</a></p></li><li><p><a href=https://www.sidewalklabs.com/>Google’s Sidewalk Labs, who are also creating smarter cities</a></p></li><li><p><a href=https://www.influxdata.com/>InfluxData website</a></p></li><li><p><a href=https://www.oreilly.com/library/view/time-series-databases/9781491920909/ch04.html>An O’Reilly chapter on Time Series tools</a></p></li></ul><p><em>If you liked this article, consider following me on Medium, or connect with me on <a href=https://www.linkedin.com/in/tomas-mc/>LinkedIn</a>.</em></p></div></div></div></div></section></div><section class=footer id=contact><div class=footer__background_shape><svg viewBox="0 0 1920 79"><path d="M0 0h1920v79L0 0z" data-name="Path 1450"/></svg></div><div class=container><div class=row><div class=col-lg-12><div class=footer__cta><div class=shape-1><svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029"><path data-name="Path 1449" d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z" transform="translate(217.489 188.626)"/></svg></div><div class=shape-2><svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029"><path data-name="Path 1449" d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z" transform="translate(217.489 188.626)"/></svg></div><div class="text-light footer__cta_content"><span>Contact me</span><h2 class=mb-0>Let's Get in Touch</h2></div><div class=footer__cta_action><a class="btn btn-light btn-zoom" href=https://tomas.mcnamer.ca/contact>Get in
touch</a></div></div></div></div><div class="row footer__widget"><div class=col-lg-4><div class="footer__widget_logo mb-5"><img src=https://tomas.mcnamer.ca/images/favicon-1.png alt=widget-logo style=max-height:50px></div></div><div class=col-lg-4><div class="text-light footer__widget_sitemap mb-5"><h3 class=base-font>Sitemap</h3><ul class="unstyle-list small"><li class=mb-2><a class=text-light href=https://tomas.mcnamer.ca/contact>Contact me</a></li><li class=mb-2><a class=text-light href=https://tomas.mcnamer.ca/portfolio>Portfolio</a></li><li class=mb-2><a class=text-light href=https://tomas.mcnamer.ca/blog>Blog</a></li><li class=mb-2><a class=text-light href=https://tomas.mcnamer.ca/>Latest Article</a></li></ul></div></div><div class=col-lg-4><div class="text-light footer__widget_address mb-5"><h3 class=base-font>Contact</h3><ul class="fa-ul small"><li class=mb-2><a class=text-light href=tel:><span class=fa-li><i class="fa fa-phone"></i></span></a></li><li class=mb-2><a class=text-light href=mailto:tommcn@mcnamer.ca><span class=fa-li><i class="fa fa-envelope"></i></span>tommcn@mcnamer.ca</a></li></ul></div></div></div><div class="row footer__footer"><div class=col-lg-6><div class="footer__footer_copy text-light"><p>All right reserved copyright © Tomas McNamer 2022</p></div></div><div class=col-lg-6><div class=footer__footer_social><ul class=unstyle-list><li class="d-inline-block mx-2"><a class=text-light target=_blank href=https://www.linkedin.com/in/tomas-mc aria-label="Social link"><i class="fa fa-linkedin-square"></i></a></li><li class="d-inline-block mx-2"><a class=text-light target=_blank href=https://github.com/tommcn aria-label="Social link"><i class="fa fa-github-square"></i></a></li><li class="d-inline-block mx-2"><a class=text-light target=_blank href=mailto:tommcn@mcnamer.ca aria-label="Social link"><i class="fa fa-envelope-square"></i></a></li></ul></div></div></div></div></section><script src=https://tomas.mcnamer.ca/plugins/jQuery/jquery.min.js></script>
<script src=https://tomas.mcnamer.ca/plugins/bootstrap/bootstrap.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/slick/slick.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/waypoint/jquery.waypoints.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/magnafic-popup/jquery.magnific-popup.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/gsap/gsap.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/imagesloaded/imagesloaded.min.js defer></script>
<script src=https://tomas.mcnamer.ca/plugins/masonry/masonry.min.js defer></script>
<script src=https://tomas.mcnamer.ca/js/form-handler.min.js></script>
<script src=https://tomas.mcnamer.ca/js/script.min.js></script></body></html>